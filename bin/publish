#!/usr/bin/env bash
set -euo pipefail

# Optional: Set crate name explicitly
CRATE_NAME=$(basename "$(pwd)")

echo "ğŸ” Running clippy..."
cargo clippy --workspace --all-targets --all-features -- -D warnings

echo "âœ… Running tests..."
cargo test --workspace --all-features

echo "ğŸ”§ Building crate..."
cargo build --workspace --release

echo "ğŸ“¦ Dry-run publishing axtra_macros..."
cargo publish -p axtra_macros --dry-run

echo "ğŸ“¦ Dry-run publishing axtra..."
cargo publish -p axtra --dry-run

read -p "ğŸš€ Ready to publish '$CRATE_NAME'? [y/N]: " confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  echo "ğŸš€ Publishing axtra_macros first..."
  cargo publish -p axtra_macros
  
  echo "â³ Waiting for crates.io to update..."
  sleep 30
  
  echo "ğŸš€ Publishing axtra..."
  cargo publish -p axtra
  
  echo "âœ… All crates published successfully!"
else
  echo "ğŸ›‘ Publish canceled."
fi
